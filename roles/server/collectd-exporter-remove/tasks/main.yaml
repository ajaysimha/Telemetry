# The port numbers will be gathered from the group_vars/all file
- name: Set port numbers for collectd exporters
  set_fact:
    collectd_ports: "{{ groups | flatten | select('match', 'pod[0-9]') | map('regex_replace', '_.+$', '') | list | unique | map('regex_replace', '$', '_collectd_port') | map('extract', vars)| list }}"

- name: Find collectd systemd service
  find:
    path: /etc/systemd/system
    pattern: 'collectd_exporter_*'
  register: service_filenames

- name: Stop collectd exporter services
  service:
    name: "collectd_exporter_{{ item }}"
    state: stopped
    enabled: no
  with_items: "{{ collectd_ports }}"
  when: service_filenames.files[0] is defined

- name: Find the name of the collectd exporter unarchived directory
  find:
    path: /opt
    patterns: '*collectd_exporter*'
    file_type: directory
  register: dir_name

- name: Delete /opt/collectd-exporter directory
  file:
    path: "{{ dir_name.files[0].path }}"
    state: absent
  when: dir_name.files[0] is defined
  

- name: Delete collectd systemd service files
  file:
    path: /etc/systemd/system/collectd_exporter_{{ item }}.service
    state: absent
  with_items: "{{ collectd_ports }}"

- name: Check if firewalld is installed
  yum:
    list: firewalld
  register: firewalld_op

- name: Close tcp ports for collectd exporter
  firewalld:
    port: "{{ item }}/tcp"
    permanent: true
    state: disabled
    immediate: true
  with_items: "{{ collectd_ports }}"
  when: firewalld_op.results|selectattr("yumstate", "match", "installed")|list|length != 0

- name: Close udp ports for collectd exporter
  firewalld:
    port: "{{ item }}/udp"
    permanent: true
    state: disabled
    immediate: true
  with_items: "{{ collectd_ports }}"
  when: firewalld_op.results|selectattr("yumstate", "match", "installed")|list|length != 0

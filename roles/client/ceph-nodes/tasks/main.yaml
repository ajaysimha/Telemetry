- name: Copy collectd rpm /tmp
  copy:
    src: "{{ telemetry_home }}/packages/{{ item }}"
    dest: /tmp
  with_items:
    - "{{ collectd_packages_all }}"
    - "{{ collectd_packages_ceph }}"

- name: Install collectd package
  yum:
    name: "/tmp/{{ item }}"
    state: present
  with_items:
    - "{{ collectd_packages_all }}"
    - "{{ collectd_packages_ceph }}"
    
- name: Configure collectd client to send metrics to collectd exporter
  template:
    src: collectd_conf.j2
    dest: /etc/collectd.conf

- name: Create /usr/share/collectd/exec directory
  file:
    path: /usr/share/collectd/exec
    state: directory
    mode: 0755

- name: Copy nfvi-services.sh to /usr/share/collectd/exec directory
  copy:
    src: ceph-nfvi-services.sh
    dest: /usr/share/collectd/exec/nfvi-services.sh
    mode: 0755

- name: Copy discover-disks.sh to /usr/local/sbin directory
  copy:
    src: discover_disk.sh
    dest: /usr/local/sbin/
    force: no
    mode: 0755

- name: Copy netif_discovery.sh to /usr/local/sbin directory
  copy:
    src: netif_discovery.sh
    dest: /usr/local/sbin/
    force: no
    mode: 0755

- name: Ensure netif_discovery.sh.log file is owned by nobody
  file: 
    path: /var/log/netif_discovery.sh.log
    owner: nobody
    group: nobody
    state: touch

- name: Copy smart-health.sh to /usr/local/sbin directory
  copy:
    src: smart-health.sh
    dest: /usr/local/sbin/
    force: no
    mode: 0755

- name: Copy smart-temp.sh to /usr/local/sbin directory
  copy:
    src: smart-temp.sh
    dest: /usr/local/sbin/
    force: no
    mode: 0755

- name: Copy ceph-status.sh to /usr/local/sbin directory
  copy:
    src: ceph-status.sh
    dest: /usr/local/sbin/
    force: no
    mode: 0755

- name: Copy types.db.custom to /usr/share/collectd directory
  copy:
    src: types.db.custom
    dest: /usr/share/collectd/

- name: Find all *asok files of OSDs
  find:
    path: /var/run/ceph/
    pattern: "*.asok"
    file_type: any
  register: daemons

- name: Copy 90-ceph-plugin configuration
  template:
    src: 90-ceph-plugin-conf.j2
    dest: /etc/collectd.d/90-ceph-plugin.conf

- name: Create sudoers file for nobody
  copy:
    src: nobody.sudoers
    dest: /etc/sudoers.d/nobody

- name: Start collectd client
  service:
    name: collectd
    state: restarted
